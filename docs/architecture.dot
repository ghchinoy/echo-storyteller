digraph EchoArchitecture {
    rankdir=TB;
    node [shape=box, style=filled, fontname="Helvetica"];
    
    // Clients
    subgraph cluster_frontend {
        label = "Frontend (Flutter Web)";
        style = filled;
        color = "#FAFAFA";
        
        UI [label="EchoScreen\n(RichText + Image)", fillcolor="#E1BEE7"];
        WSClient [label="WebSocket Channel", fillcolor="#E1BEE7"];
        PcmPlayer [label="PcmPlayer\n(Web Audio API)", fillcolor="#D1C4E9", penwidth=2];
        AudioContext [label="AudioContext\n(Browser Native)", shape=ellipse, fillcolor="#F5F5F5"];
    }

    // Server
    subgraph cluster_backend {
        label = "Backend (Go)";
        style = filled;
        color = "#E0F7FA";
        
        WSHandler [label="WebSocket Handler", fillcolor="#B3E5FC"];
        
        subgraph cluster_orchestrator {
            label = "Story Orchestrator";
            style = dashed;
            Producer [label="Producer\n(Text/Image Gen)", fillcolor="#B3E5FC"];
            Channel [label="Sentence Chan", shape=cds, fillcolor="#E1F5FE"];
            Consumer [label="Consumer\n(TTS Feeder)", fillcolor="#B3E5FC"];
        }
        
        GeminiClient [label="Gemini Client\n(GenerateContentStream)", fillcolor="#FFF9C4"];
        TTSClient [label="TTS Client\n(StreamingSynthesize)", fillcolor="#FFF9C4"];
    }

    // Cloud
    subgraph cluster_gcp {
        label = "Google Cloud";
        style = dotted;
        VertexAI [label="Vertex AI\n(Gemini 3 Pro Preview)", shape=cloud, fillcolor="#FFFFFF"];
        VertexImage [label="Vertex AI\n(Gemini 3 Pro Image)", shape=cloud, fillcolor="#FFFFFF"];
        CloudTTS [label="Cloud TTS\n(Gemini 2.5 Flash/Pro)", shape=cloud, fillcolor="#FFFFFF"];
    }

    // Flow
    UI -> WSClient [label="1. Send Topic"];
    WSClient -> WSHandler [label="WS Message"];
    WSHandler -> Producer [label="Topic"];
    
    // Text Generation
    Producer -> GeminiClient [label="2a. Text Prompt"];
    GeminiClient -> VertexAI [label="RPC"];
    VertexAI -> GeminiClient [label="Token Stream"];
    Producer -> WSHandler [label="2b. Send Text (JSON)"];
    Producer -> Channel [label="Full Sentence"];

    // Image Generation (Parallel)
    Producer -> VertexImage [label="2c. Image Prompt"];
    VertexImage -> Producer [label="Base64 Image"];
    Producer -> WSHandler [label="2d. Send Image (JSON)"];

    // TTS (Sequential)
    Channel -> Consumer [label="Read Sentence"];
    Consumer -> TTSClient [label="3. Send Text (New Stream)"];
    TTSClient -> CloudTTS [label="RPC (LINEAR16)"];
    CloudTTS -> TTSClient [label="Audio Chunks"];
    
    TTSClient -> WSHandler [label="Audio Bytes"];
    WSHandler -> WSClient [label="4. Binary Message"];
    
    // Playback
    WSClient -> UI [label="Text/Image Update"];
    WSClient -> PcmPlayer [label="Feed Bytes"];
    PcmPlayer -> AudioContext [label="decode -> schedule"];
}